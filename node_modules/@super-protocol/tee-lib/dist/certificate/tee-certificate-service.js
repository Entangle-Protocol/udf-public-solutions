"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TeeCertificateService = void 0;
const node_forge_1 = require("node-forge");
const addons_tee_1 = require("@super-protocol/addons-tee");
const errors_1 = require("./errors");
const calculate_hash_1 = require("../helpers/calculate-hash");
class TeeCertificateService {
    constructor(params) {
        this.pkiService = new addons_tee_1.SgxNative.PkiService();
        this.logger = params.logger?.child({ name: TeeCertificateService.name });
        this.caStore = node_forge_1.pki.createCaStore();
        this.teeDevice = params.teeDevice;
    }
    static parseCertificate(contentDerOrPem) {
        const pemHead = '-----BEGIN CERTIFICATE-----';
        const data = contentDerOrPem.slice(0, pemHead.length).compare(Buffer.from(pemHead)) === 0
            ? node_forge_1.pki.pemToDer(contentDerOrPem.toString())
            : node_forge_1.util.createBuffer(contentDerOrPem);
        const asn1Obj = node_forge_1.asn1.fromDer(data);
        const asn1Cert = node_forge_1.pki.certificateFromAsn1(asn1Obj);
        return Promise.resolve(asn1Cert);
    }
    async verifyCertificate(cert) {
        const certsChainObjects = (typeof cert === 'string'
            ? cert
                .split(/^-----END CERTIFICATE-----\n?/gm)
                .filter(Boolean)
                .map((c) => Buffer.concat([Buffer.from(c), Buffer.from('-----END CERTIFICATE-----')]))
            : cert).map((c) => TeeCertificateService.parseCertificate(c));
        const certsChain = await Promise.all(certsChainObjects);
        return node_forge_1.pki.verifyCertificateChain(this.caStore, certsChain, { validityCheckDate: new Date() });
    }
    async verifyTlsCertificateChain(certChainInPem) {
        const logger = this.logger?.child({
            method: 'verifyCertificate',
        });
        try {
            await this.pkiService.validateChain(Buffer.from(certChainInPem), addons_tee_1.SgxNative.CertificateFormat.PEM);
            return null;
        }
        catch (error) {
            logger?.debug({ err: error }, 'Fail to verify certificate');
            return error.message;
        }
    }
    async verifyTlsCertificateHostname(certChainInPem, hostnameOrIp) {
        const logger = this.logger?.child({
            method: 'verifyTlsCertificateHostname',
            hostnameOrIp,
        });
        try {
            return await this.pkiService.validateHostname(Buffer.from(certChainInPem), hostnameOrIp, addons_tee_1.SgxNative.CertificateFormat.PEM);
        }
        catch (error) {
            logger?.debug({ err: error }, 'Fail to verify certificate hostname');
            return false;
        }
    }
    parseAndValidateTlsCertificate(cert) {
        return this.teeDevice.parseAndValidateTlsCertificate(cert);
    }
    async generateQuote(publicKey) {
        const methodLogger = this.logger?.child({ method: 'generateQuote' });
        methodLogger?.trace('Get public key in der format');
        const publicKeyData = Buffer.from(node_forge_1.asn1.toDer(node_forge_1.pki.publicKeyToAsn1(publicKey)).getBytes(), 'binary');
        methodLogger?.trace('Calc public key hash');
        const publicKeyHash = (0, calculate_hash_1.calculateHash)(publicKeyData, 'sha256');
        methodLogger?.trace({ publicKeyHash: publicKeyHash.toString('hex') }, 'Generate quote with sha256 hash of public key');
        const quote = await this.teeDevice.getDataOf(publicKeyHash);
        return quote;
    }
    async generateCsr(params) {
        const logger = this.logger?.child({
            method: 'generateCsr',
        });
        const keys = node_forge_1.pki.rsa.generateKeyPair(params.rsaKeyBits ?? 3072);
        const csr = node_forge_1.pki.createCertificationRequest();
        csr.publicKey = keys.publicKey;
        const subject = [
            {
                name: 'commonName',
                value: params.subject.commonName,
            },
            {
                name: 'organizationName',
                value: params.subject.organizationName || 'SuperProtocol',
            },
            {
                shortName: 'OU',
                value: params.subject.organizationUnit || 'TEE',
            },
        ];
        csr.setSubject(subject);
        const attributes = [
            {
                name: 'extensionRequest',
                extensions: [
                    {
                        name: 'subjectAltName',
                        altNames: [
                            {
                                // type 2 is DNS
                                type: 2,
                                value: params.subject.commonName,
                            },
                        ],
                    },
                    ...(params.withQuote
                        ? [
                            {
                                id: TeeCertificateService.certOidQuote,
                                value: node_forge_1.util.createBuffer(await this.generateQuote(csr.publicKey)).getBytes(),
                                // value: asn1.create(
                                //   asn1.Class.UNIVERSAL,
                                //   asn1.Type.OCTETSTRING,
                                //   false,
                                //   quote!.getBytes(),
                                // ),
                            },
                        ]
                        : []),
                ],
            },
        ];
        csr.setAttributes(attributes);
        logger?.trace('Self sign');
        csr.sign(keys.privateKey, node_forge_1.md.sha256.create());
        const csrPem = node_forge_1.pki.certificationRequestToPem(csr).replaceAll(/\r/g, '').replace(/\n$/, '');
        const privateKeyPem = node_forge_1.pki.privateKeyToPem(keys.privateKey);
        return { privateKeyPem, csrPem };
    }
    async generateTlsCertificate(params = {}) {
        const logger = this.logger?.child({
            method: 'generateTlsCertificate',
        });
        if (params.format && !['PEM', 'DER'].includes(params.format)) {
            throw new errors_1.TeeCertificateServiceInvalidArguments('Invalid format for generation of certificate');
        }
        // @TODO: validate other params
        logger?.trace('Generate pair');
        const keys = node_forge_1.pki.rsa.generateKeyPair(params.rsaKeyBits ?? 3072);
        const cert = node_forge_1.pki.createCertificate();
        cert.publicKey = keys.publicKey;
        cert.serialNumber = params.serialNumber ?? '01';
        cert.validity.notBefore = new Date();
        cert.validity.notAfter = new Date();
        cert.validity.notAfter.setFullYear(cert.validity.notBefore.getFullYear() + (params.years ?? 1));
        const attrs = [
            {
                name: 'commonName',
                value: params.subject?.commonName ?? 'localhost',
            },
            {
                name: 'countryName',
                value: params.subject?.countryName ?? 'US',
            },
            {
                shortName: 'ST',
                value: params.subject?.state ?? 'New York',
            },
            {
                name: 'localityName',
                value: params.subject?.localityName ?? 'New York',
            },
            {
                name: 'organizationName',
                value: params.subject?.organizationName ?? 'SuperProtocol',
            },
            {
                shortName: 'OU',
                value: params.subject?.organizationUnit ?? 'TEE',
            },
        ];
        cert.setSubject(attrs);
        cert.setIssuer(attrs);
        const exts = [
            {
                name: 'basicConstraints',
                cA: true,
            },
            {
                name: 'keyUsage',
                keyCertSign: true,
                digitalSignature: true,
                nonRepudiation: true,
                keyEncipherment: true,
                dataEncipherment: true,
            },
            {
                name: 'extKeyUsage',
                serverAuth: true,
                clientAuth: true,
                codeSigning: true,
            },
            {
                name: 'subjectAltName',
                altNames: [
                    ...(params.dnsNames ?? []).map((value) => ({
                        type: 2,
                        value,
                    })),
                    {
                        type: 2,
                        value: 'localhost',
                    },
                    ...(params.ips ?? []).map((ip) => ({
                        type: 7,
                        ip,
                    })),
                    {
                        type: 7,
                        ip: '127.0.0.1',
                    },
                ],
            },
            {
                name: 'subjectKeyIdentifier',
            },
            ...(params.withQuote
                ? [
                    {
                        id: TeeCertificateService.certOidQuote,
                        value: node_forge_1.util.createBuffer(await this.generateQuote(cert.publicKey)).getBytes(),
                        // value: asn1.create(
                        //   asn1.Class.UNIVERSAL,
                        //   asn1.Type.OCTETSTRING,
                        //   false,
                        //   quote!.getBytes(),
                        // ),
                    },
                ]
                : []),
        ];
        cert.setExtensions(exts);
        logger?.trace('Self sign');
        cert.sign(keys.privateKey, node_forge_1.md.sha256.create());
        logger?.trace('Return result');
        return {
            format: params.format ?? 'PEM',
            cert: Buffer.from(params.format === 'DER'
                ? node_forge_1.pki.pemToDer(node_forge_1.pki.certificateToPem(cert)).bytes()
                : node_forge_1.pki.certificateToPem(cert)),
            key: Buffer.from(params.format === 'DER'
                ? node_forge_1.pki.pemToDer(node_forge_1.pki.privateKeyToPem(keys.privateKey)).bytes()
                : node_forge_1.pki.privateKeyToPem(keys.privateKey)),
        };
    }
}
exports.TeeCertificateService = TeeCertificateService;
TeeCertificateService.certOidQuote = '0.6.9.42.840.113741.1337.6';
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVlLWNlcnRpZmljYXRlLXNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY2VydGlmaWNhdGUvdGVlLWNlcnRpZmljYXRlLXNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsMkNBQWlEO0FBQ2pELDJEQUF1RDtBQVd2RCxxQ0FBaUU7QUFDakUsOERBQTBEO0FBYTFELE1BQWEscUJBQXFCO0lBUWhDLFlBQVksTUFBbUM7UUFIOUIsZUFBVSxHQUFHLElBQUksc0JBQVMsQ0FBQyxVQUFVLEVBQUUsQ0FBQztRQUl2RCxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQyxNQUFNLEVBQUUsS0FBSyxDQUFDLEVBQUUsSUFBSSxFQUFFLHFCQUFxQixDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7UUFDekUsSUFBSSxDQUFDLE9BQU8sR0FBRyxnQkFBRyxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ25DLElBQUksQ0FBQyxTQUFTLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQztJQUNwQyxDQUFDO0lBRUQsTUFBTSxDQUFDLGdCQUFnQixDQUFDLGVBQXVCO1FBQzdDLE1BQU0sT0FBTyxHQUFHLDZCQUE2QixDQUFDO1FBRTlDLE1BQU0sSUFBSSxHQUNSLGVBQWUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLENBQUM7WUFDMUUsQ0FBQyxDQUFDLGdCQUFHLENBQUMsUUFBUSxDQUFDLGVBQWUsQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUMxQyxDQUFDLENBQUMsaUJBQUksQ0FBQyxZQUFZLENBQUMsZUFBZSxDQUFDLENBQUM7UUFFekMsTUFBTSxPQUFPLEdBQUcsaUJBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDbkMsTUFBTSxRQUFRLEdBQUcsZ0JBQUcsQ0FBQyxt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