"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const BaseConnector_1 = require("./BaseConnector");
const web3_1 = __importStar(require("web3"));
const web3_eth_abi_1 = require("web3-eth-abi");
const constants_1 = require("../constants");
const helper_1 = require("../utils/helper");
const TxManager_1 = __importDefault(require("../utils/TxManager"));
const abi_1 = require("../contracts/abi");
const ethers_1 = require("ethers");
// TODO: remove this dependencies
const store_1 = __importDefault(require("../store"));
const Superpro_1 = __importDefault(require("../staticModels/Superpro"));
const SuperproToken_1 = __importDefault(require("../staticModels/SuperproToken"));
const Monitoring_1 = require("../utils/Monitoring");
class BlockchainConnector extends BaseConnector_1.BaseConnector {
    constructor() {
        super();
    }
    static getInstance() {
        if (!BlockchainConnector.instance) {
            BlockchainConnector.instance = new BlockchainConnector();
        }
        return BlockchainConnector.instance;
    }
    /**
     * Function for connecting to blockchain
     * Used to setting up settings for blockchain connector
     * Needs to run this function before using blockchain connector
     */
    initialize(config) {
        var _a;
        return __awaiter(this, void 0, void 0, function* () {
            this.logger.trace(config, 'Initializing');
            const url = (config === null || config === void 0 ? void 0 : config.blockchainUrl) || constants_1.defaultBlockchainUrl;
            store_1.default.web3Https = new web3_1.default(url);
            const web3Context = new web3_1.Web3Context({
                provider: store_1.default.web3Https.currentProvider,
                config: { contractDataInputFill: 'data' },
            });
            store_1.default.gasPrice = (_a = config === null || config === void 0 ? void 0 : config.gasPrice) !== null && _a !== void 0 ? _a : constants_1.defaultGasPrice;
            if (config === null || config === void 0 ? void 0 : config.gasLimit)
                store_1.default.gasLimit = config.gasLimit;
            if (config === null || config === void 0 ? void 0 : config.gasLimitMultiplier)
                store_1.default.gasLimitMultiplier = config.gasLimitMultiplier;
            if (config === null || config === void 0 ? void 0 : config.gasPriceMultiplier)
                store_1.default.gasPriceMultiplier = config.gasPriceMultiplier;
            if (config === null || config === void 0 ? void 0 : config.txConcurrency)
                store_1.default.txConcurrency = config.txConcurrency;
            if (config === null || config === void 0 ? void 0 : config.txIntervalMs)
                store_1.default.txIntervalMs = config.txIntervalMs;
            Superpro_1.default.address = config.contractAddress;
            this.contract = new web3_1.Contract(abi_1.abi, Superpro_1.default.address, web3Context);
            TxManager_1.default.init(store_1.default.web3Https);
            SuperproToken_1.default.addressHttps = yield Superpro_1.default.getTokenAddress(this.contract);
            Monitoring_1.Monitoring.getInstance().initializeLogging();
            this.initialized = true;
            this.logger.trace('Initialized');
        });
    }
    /**
     * Function for connecting provider action account
     * Needs to run this function before using any set methods in blockchain connector
     */
    initializeActionAccount(actionAccountKey, manageNonce = true) {
        return __awaiter(this, void 0, void 0, function* () {
            this.checkIfInitialized();
            store_1.default.web3Https.eth.accounts.wallet.add(actionAccountKey);
            const actionAccount = store_1.default.web3Https.eth.accounts.privateKeyToAccount(actionAccountKey).address;
            if (!store_1.default.actionAccount)
                store_1.default.actionAccount = actionAccount;
            if (!store_1.default.keys[actionAccount])
                store_1.default.keys[actionAccount] = actionAccountKey;
            if (!this.defaultActionAccount)
                this.defaultActionAccount = actionAccount;
            if (manageNonce) {
                yield TxManager_1.default.initAccount(actionAccount);
            }
            return actionAccount;
        });
    }
    /**
     * Returns balance of blockchain platform tokens in wei
     */
    getBalance(address) {
        this.checkIfInitialized();
        return store_1.default.web3Https.eth.getBalance(address).then((balance) => balance.toString());
    }
    getTimestamp() {
        var _a;
        return __awaiter(this, void 0, void 0, function* () {
            this.checkIfInitialized();
            const block = yield ((_a = store_1.default.web3Https) === null || _a === void 0 ? void 0 : _a.eth.getBlock('latest'));
            return block.timestamp;
        });
    }
    /**
     * Returns transactions events info
     * @param txHash - transaction hash
     * @returns {Promise<EventData[]>} - Transaction events info
     */
    getTransactionEvents(txHash) {
        return __awaiter(this, void 0, void 0, function* () {
            this.checkIfInitialized();
            const receipt = yield store_1.default.web3Https.eth.getTransactionReceipt(txHash);
            const eventData = [];
            const eventsDescriptor = abi_1.abi
                .filter((desc) => desc.type === 'event')
                .map((desc) => (Object.assign(Object.assign({}, desc), { signature: (0, web3_eth_abi_1.encodeEventSignature)(desc) })));
            for (const log of receipt.logs) {
                if (!log.address || log.address === constants_1.POLYGON_MATIC_EVENT_PATH) {
                    continue;
                }
                const descriptor = eventsDescriptor.find((desc) => { var _a; return desc.signature === ((_a = log.topics) === null || _a === void 0 ? void 0 : _a[0]); });
                if (descriptor) {
                    const decodedParams = (0, web3_eth_abi_1.decodeLog)(descriptor.inputs, log.data, log.topics.slice(1));
                    eventData.push({
                        contract: log.address,
                        name: descriptor.name || 'UknownEvenet',
                        data: (0, helper_1.cleanWeb3Data)(decodedParams),
                    });
                }
            }
            return eventData;
        });
    }
    /**
     * Function for adding event listeners on TEE offer created event in TEE offers factory contract
     * @param callback - function for processing created TEE offer
     * @returns unsubscribe - unsubscribe function from event
     */
    getLastBlockInfo() {
        return __awaiter(this, void 0, void 0, function* () {
            this.checkIfInitialized();
            const index = Number(yield store_1.default.web3Https.eth.getBlockNumber());
            const hash = (yield store_1.default.web3Https.eth.getBlock(index)).hash;
            return {
                index,
                hash,
            };
        });
    }
    /**
     * Returns transactions reciept
     * @param txHash - transaction hash
     * @returns {Promise<TransactionReceipt>} - Transaction reciept
     */
    getTransactionReceipt(txHash) {
        this.checkIfInitialized();
        return store_1.default.web3Https.eth.getTransactionReceipt(txHash);
    }
    /**
     * Returns balance of blockchain platform tokens in wei
     */
    transfer(to, amount, transactionOptions) {
        this.checkIfInitialized();
        (0, helper_1.checkIfActionAccountInitialized)(transactionOptions);
        const transaction = {
            to,
            value: amount,
        };
        return TxManager_1.default.publishTransaction(transaction, transactionOptions);
    }
    /**
     * Returns transactions count
     * @param address - wallet address
     * @returns {Promise<number>} - Transactions count
     */
    getTransactionCount(address, status) {
        return __awaiter(this, void 0, void 0, function* () {
            this.checkIfInitialized();
            if (status) {
                return Number(yield store_1.default.web3Https.eth.getTransactionCount(address, status));
            }
            else {
                return Number(yield store_1.default.web3Https.eth.getTransactionCount(address));
            }
        });
    }
    getAddressByKey(pk) {
        return new ethers_1.Wallet(pk).address;
    }
    /**
     * Fetch transactions for specific addresses starting with specific block until last block
     * @param addresses - array of addresses IN LOWER CASE to fetch transactions (from these addresses and to these addresses)
     * @param startBlock - number of block to start fetching transactions (if empty fetch only for last block)
     * @param lastBlock - number of block to last fetching transactions (if empty fetch only for last block)
     * @param batchSize - block size for asynchronous transaction loading
     * @returns {Promise<{
     *   transactionsByAddress, - found transactions sorted by addresses
     *   lastBlock, - number of last fetched block (can be used to start fetching from this block next time)
     * }>}
     */
    getTransactions({ addresses, startBlock, lastBlock, batchSize = constants_1.BLOCK_SIZE_TO_FETCH_TRANSACTION, timeout, }) {
        return __awaiter(this, void 0, void 0, function* () {
            this.checkIfInitialized();
            const blockchainLastBlock = Number(yield store_1.default.web3Https.eth.getBlockNumber());
            if (lastBlock) {
                lastBlock = Math.min(lastBlock, blockchainLastBlock);
            }
            else {
                lastBlock = blockchainLastBlock;
            }
            if (!startBlock) {
                startBlock = Math.max(lastBlock - 1000, 0);
            }
            const transactionsByAddress = {};
            const validAddresses = addresses
                .filter((address) => { var _a; return (_a = store_1.default.web3Https) === null || _a === void 0 ? void 0 : _a.utils.isAddress(address); })
                .map((address) => {
                const lowerCaseAddress = address.toLowerCase();
                if (address !== lowerCaseAddress) {
                    this.logger.warn({ address }, `Must use adresses in lower case fomat! ${address} -> ${lowerCaseAddress}`);
                }
                return lowerCaseAddress;
            });
            if (!validAddresses.length) {
                return {
                    transactionsByAddress,
                    lastBlock,
                };
            }
            validAddresses.forEach((address) => (transactionsByAddress[address] = []));
            while (startBlock <= lastBlock) {
                const batch = new store_1.default.web3Https.BatchRequest();
                const batchLastBlock = Math.min(startBlock + batchSize - 1, lastBlock);
                for (let blockNumber = startBlock; blockNumber <= batchLastBlock; blockNumber++) {
                    const hexedBlockNumber = '0x' + blockNumber.toString(16);
                    batch
                        .add({
                        jsonrpc: '2.0',
                        method: 'eth_getBlockByNumber',
                        params: [hexedBlockNumber, true],
                    })
                        .catch((err) => this.logger.error(err));
                }
                const blocks = yield (0, helper_1.executeBatchAsync)(batch, timeout);
                blocks.forEach((block) => {
                    if (!(block === null || block === void 0 ? void 0 : block.transactions))
                        return;
                    block.transactions.forEach((transaction) => {
                        if (typeof transaction === 'string') {
                            return;
                        }
                        let address = null;
                        if (validAddresses.includes(transaction.from))
                            address = transaction.from;
                        else if (transaction.to && validAddresses.includes(transaction.to))
                            address = transaction.to;
                        if (address) {
                            transactionsByAddress[address].push(Object.assign(Object.assign({}, transaction), { timestamp: Number(block.timestamp) * 1000, input: transaction.input }));
                        }
                    });
                });
                startBlock = batchLastBlock + 1;
            }
            return {
                transactionsByAddress,
                lastBlock,
            };
        });
    }
    shutdown() {
        super.shutdown();
        store_1.default.web3Https = undefined;
        Monitoring_1.Monitoring.getInstance().shutdownLogging();
    }
}
__decorate([
    (0, helper_1.incrementMethodCall)(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String]),
    __metadata("design:returntype", Promise)
], BlockchainConnector.prototype, "getBalance", null);
__decorate([
    (0, helper_1.incrementMethodCall)(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String]),
    __metadata("design:returntype", Promise)
], BlockchainConnector.prototype, "getTransactionEvents", null);
__decorate([
    (0, helper_1.incrementMethodCall)(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String, Object]),
    __metadata("design:returntype", Promise)
], BlockchainConnector.prototype, "transfer", null);
__decorate([
    (0, helper_1.incrementMethodCall)(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object]),
    __metadata("design:returntype", Promise)
], BlockchainConnector.prototype, "getTransactions", null);
exports.default = BlockchainConnector;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQmxvY2tjaGFpbkNvbm5lY3Rvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb25uZWN0b3JzL0Jsb2NrY2hhaW5Db25uZWN0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLG1EQUF3RDtBQUN4RCw2Q0FPYztBQUNkLCtDQUErRDtBQUMvRCw0Q0FLc0I7QUFDdEIsNENBS3lCO0FBU3pCLG1FQUEyQztBQUMzQywwQ0FBdUM7QUFDdkMsbUNBQWdDO0FBRWhDLGlDQUFpQztBQUNqQyxxREFBNkI7QUFDN0Isd0VBQWdEO0FBQ2hELGtGQUEwRDtBQUMxRCxvREFBaUQ7QUFFakQsTUFBTSxtQkFBb0IsU0FBUSw2QkFBYTtJQU03QztRQUNFLEtBQUssRUFBRSxDQUFDO0lBQ1YsQ0FBQztJQUVNLE1BQU0sQ0FBQyxXQUFXO1FBQ3ZCLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxRQUFRLEVBQUU7WUFDakMsbUJBQW1CLENBQUMsUUFBUSxHQUFHLElBQUksbUJBQW1CLEVBQUUsQ0FBQztTQUMxRDtRQUVELE9BQU8sbUJBQW1CLENBQUMsUUFBUSxDQUFDO0lBQ3RDLENBQUM7SUFFRDs7OztPQUlHO0lBQ1UsVUFBVSxDQUFDLE1BQWM7OztZQUNwQyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsY0FBYyxDQUFDLENBQUM7WUFFMUMsTUFBTSxHQUFHLEdBQUcsQ0FBQSxNQUFNLGFBQU4sTUFBTSx1QkFBTixNQUFNLENBQUUsYUFBYSxLQUFJLGdDQUFvQixDQUFDO1lBQzFELGVBQUssQ0FBQyxTQUFTLEdBQUcsSUFBSSxjQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDaEMsTUFBTSxXQUFXLEdBQUcsSUFBSSxrQkFBVyxDQUFDO2dCQUNsQyxRQUFRLEVBQUUsZUFBSyxDQUFDLFNBQVMsQ0FBQyxlQUFlO2dCQUN6QyxNQUFNLEVB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