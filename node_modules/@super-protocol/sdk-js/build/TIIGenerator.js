"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const node_gzip_1 = require("node-gzip");
const lodash_1 = __importDefault(require("lodash"));
const Compression_1 = require("./proto/Compression");
const TRI_1 = require("./proto/TRI");
const crypto_1 = __importDefault(require("./crypto"));
const models_1 = require("./models");
const dto_js_1 = require("@super-protocol/dto-js");
const tee_lib_1 = require("@super-protocol/tee-lib");
const QuoteValidator_1 = require("./tee/QuoteValidator");
const statuses_1 = require("./tee/statuses");
const logger_1 = __importDefault(require("./logger"));
class TIIGenerator {
    static generateByOffer(offerId, solutionHashes, linkageString, resource, args, encryption) {
        return __awaiter(this, void 0, void 0, function* () {
            const teeOffer = new models_1.TeeOffer(offerId);
            const teeOfferInfo = yield teeOffer.getInfo();
            const linkage = linkageString
                ? JSON.parse(linkageString)
                : {
                    encoding: dto_js_1.Encoding.base64,
                    mrenclave: '',
                };
            const serializer = new tee_lib_1.TLBlockSerializerV1();
            const tlb = serializer.unserializeTlb(Buffer.from(teeOfferInfo.tlb, 'base64'));
            const validator = new QuoteValidator_1.QuoteValidator(process.env['INTEL_SGX_API_URL']);
            const quoteBuffer = Buffer.from(tlb.quote);
            const quoteStatus = yield validator.validate(quoteBuffer);
            if (quoteStatus.quoteValidationStatus !== statuses_1.QuoteValidationStatuses.UpToDate) {
                if (quoteStatus.quoteValidationStatus === statuses_1.QuoteValidationStatuses.Error) {
                    throw new Error('Quote in TLB is invalid');
                }
                else {
                    logger_1.default.warn(quoteStatus, 'Quote validation status is not UpToDate');
                }
            }
            const checkData = yield validator.isQuoteHasUserData(quoteBuffer, Buffer.from(tlb.dataBlob));
            if (!checkData) {
                throw new Error('Quote in TLB has invalid user data');
            }
            // TODO: check env with SP-149
            const mac = encryption.authTag || encryption.mac;
            const rawTri = {
                solutionHashes: solutionHashes.map((hash) => ({
                    algo: hash.algo,
                    hash: Buffer.from(hash.hash, hash.encoding),
                })),
                mrenclave: Buffer.from(linkage.mrenclave, linkage.encoding),
                args: JSON.stringify(args || ''),
                encryption: Object.assign(Object.assign({}, encryption), { ciphertext: encryption.ciphertext
                        ? Buffer.from(encryption.ciphertext, encryption.encoding)
                        : undefined, key: encryption.key ? Buffer.from(encryption.key, encryption.encoding) : undefined, iv: encryption.iv
                        ? Buffer.from(encryption.iv, encryption.encoding)
                        : undefined, mac: mac ? Buffer.from(mac, encryption.encoding) : undefined }),
            };
            const tri = TRI_1.TRI.encode(rawTri).finish();
            const compressedTri = Compression_1.Compression.encode({
                data: yield (0, node_gzip_1.gzip)(tri),
                type: Compression_1.Compression_TYPE.GZIP,
            }).finish();
            return JSON.stringify({
                encryptedResource: yield crypto_1.default.encrypt(JSON.stringify(resource), JSON.parse(teeOfferInfo.argsPublicKey)),
                tri: yield crypto_1.default.encrypt(Buffer.from(compressedTri).toString(dto_js_1.Encoding.base64), {
                    algo: dto_js_1.CryptoAlgorithm.ECIES,
                    key: Buffer.from(tlb.data.teePubKeyData).toString('base64'),
                    encoding: dto_js_1.Encoding.base64,
                }),
            });
        });
    }
    static generate(orderId, resource, args, encryption) {
        return __awaiter(this, void 0, void 0, function* () {
            const order = new models_1.Order(orderId);
            const parentOrderId = yield order.getParentOrder();
            const parentOrder = new models_1.Order(parentOrderId);
            const parentOrderInfo = yield parentOrder.getOrderInfo();
            const { hashes, linkage } = yield this.getSolutionHashesAndLinkage(parentOrderInfo.args.inputOffers);
            return this.generateByOffer(parentOrderInfo.offerId, hashes, linkage, resource, args, encryption);
        });
    }
    static getSolutionHashesAndLinkage(inputOffers) {
        return __awaiter(this, void 0, void 0, function* () {
            const solutionHashes = [];
            let solutionLinkage;
            let anyLinkage;
            yield Promise.all(inputOffers.map((offerId) => __awaiter(this, void 0, void 0, function* () {
                const offer = new models_1.Offer(offerId);
                const offerInfo = yield offer.getInfo();
                if (offerInfo.hash) {
                    solutionHashes.push(JSON.parse(offerInfo.hash));
                }
                const restrictions = lodash_1.default.intersection(offerInfo.restrictions.offers, inputOffers).filter((restrictedOfferId) => restrictedOfferId !== offer.id);
                if (restrictions.length) {
                    solutionLinkage = offerInfo.linkage;
                }
                else {
                    anyLinkage = offerInfo.linkage;
                }
            })));
            return {
                hashes: solutionHashes,
                linkage: solutionLinkage || anyLinkage,
            };
        });
    }
    static getTRI(tii, decryptionKey) {
        return __awaiter(this, void 0, void 0, function* () {
            const tiiObj = JSON.parse(tii);
            tiiObj.tri.key = decryptionKey.toString(tiiObj.tri.encoding);
            const tri = yield crypto_1.default.decrypt(tiiObj.tri);
            const compression = Compression_1.Compression.decode(Buffer.from(tri, tiiObj.tri.encoding));
            let decompressed;
            switch (compression.type) {
                case Compression_1.Compression_TYPE.GZIP:
                    decompressed = yield (0, node_gzip_1.ungzip)(compression.data);
                    break;
                default:
                    throw Error('Unknown compression method');
            }
            const decoded = TRI_1.TRI.decode(decompressed);
            return {
                solutionHashes: decoded.solutionHashes.map((hash) => ({
                    hash: Buffer.from(hash.hash).toString(dto_js_1.Encoding.base64),
                    algo: hash.algo,
                    encoding: dto_js_1.Encoding.base64,
                })),
                linkage: {
                    encoding: dto_js_1.Encoding.base64,
                    mrenclave: Buffer.from(decoded.mrenclave).toString(dto_js_1.Encoding.base64),
                },
                args: decoded.args,
                encryption: {
                    algo: decoded.encryption.algo,
                    cipher: decoded.encryption.cipher,
                    encoding: dto_js_1.Encoding.base64,
                    key: Buffer.from(decoded.encryption.key).toString(dto_js_1.Encoding.base64),
                    iv: decoded.encryption.iv && Buffer.from(decoded.encryption.iv).toString(dto_js_1.Encoding.base64),
                    mac: decoded.encryption.mac &&
                        Buffer.from(decoded.encryption.mac).toString(dto_js_1.Encoding.base64),
                },
            };
        });
    }
    static getUrl(tii, decryptionKey) {
        return __awaiter(this, void 0, void 0, function* () {
            const res = yield TIIGenerator.getResource(tii, decryptionKey);
            return res.url;
        });
    }
    static getResource(tii, decryptionKey) {
        return __awaiter(this, void 0, void 0, function* () {
            const encryptedResource = JSON.parse(tii).encryptedResource;
            encryptedResource.key = decryptionKey.toString(encryptedResource.encoding);
            const resource = yield crypto_1.default.decrypt(encryptedResource);
            return JSON.parse(resource);
        });
    }
}
exports.default = TIIGenerator;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVElJR2VuZXJhdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL1RJSUdlbmVyYXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztBQUFBLHlDQUF5QztBQUN6QyxvREFBdUI7QUFFdkIscURBQW9FO0FBQ3BFLHFDQUFrQztBQUNsQyxzREFBOEI7QUFDOUIscUNBQWtEO0FBRWxELG1EQVlnQztBQUNoQyxxREFBNEY7QUFDNUYseURBQXNEO0FBQ3RELDZDQUF5RDtBQUN6RCxzREFBOEI7QUFFOUIsTUFBTSxZQUFZO0lBQ1QsTUFBTSxDQUFPLGVBQWUsQ0FDakMsT0FBcUIsRUFDckIsY0FBc0IsRUFDdEIsYUFBaUMsRUFDakMsUUFBa0IsRUFDbEIsSUFBUyxFQUNULFVBQXNCOztZQUV0QixNQUFNLFFBQVEsR0FBYSxJQUFJLGlCQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDakQsTUFBTSxZQUFZLEdBQWlCLE1BQU0sUUFBUSxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBRTVELE1BQU0sT0FBTyxHQUFZLGFBQWE7Z0JBQ3BDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQztnQkFDM0IsQ0FBQyxDQUFDO29CQUNFLFFBQVEsRUFBRSxpQkFBUSxDQUFDLE1BQU07b0JBQ3pCLFNBQVMsRUFBRSxFQUFFO2lCQUNkLENBQUM7WUFFTixNQUFNLFVBQVUsR0FBRyxJQUFJLDZCQUFtQixFQUFFLENBQUM7WUFDN0MsTUFBTSxHQUFHLEdBQWlDLFVBQVUsQ0FBQyxjQUFjLENBQ2pFLE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsRUFBRSxRQUFRLENBQUMsQ0FDeEMsQ0FBQztZQUNGLE1BQU0sU0FBUyxHQUFHLElBQUksK0JBQWMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixDQUFDLENBQUMsQ0FBQztZQUN2RSxNQUFNLFdBQVcsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFD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