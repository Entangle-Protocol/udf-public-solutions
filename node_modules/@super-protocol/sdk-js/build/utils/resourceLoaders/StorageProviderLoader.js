"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.StorageProviderLoader = void 0;
const fs_1 = __importDefault(require("fs"));
const stream_1 = __importDefault(require("stream"));
const dto_js_1 = require("@super-protocol/dto-js");
const ChunksDownloadDecorator_1 = require("../../providers/storage/ChunksDownloadDecorator");
const getStorageProvider_1 = __importDefault(require("../../providers/storage/getStorageProvider"));
const BaseResourceLoader_1 = require("./BaseResourceLoader");
class StorageProviderLoader extends BaseResourceLoader_1.BaseResourceLoader {
    constructor(config = {}) {
        var _a, _b, _c;
        super();
        this.progressListener = config.progressListener;
        this.chunkSize = config.chunkSize;
        this.concurrency = config.concurrency;
        this.startOffset = config.startOffset || StorageProviderLoader.DEFAULT_START_OFFSET;
        this.retry = {
            retryMaxCount: ((_a = config.retry) === null || _a === void 0 ? void 0 : _a.retryMaxCount) || StorageProviderLoader.DEFAULT_RETRY_COUNT,
            onRetry: (_b = config.retry) === null || _b === void 0 ? void 0 : _b.onRetry,
            retryWaitTimeFactory: (_c = config.retry) === null || _c === void 0 ? void 0 : _c.retryWaitTimeFactory,
        };
    }
    download(resource) {
        return __awaiter(this, void 0, void 0, function* () {
            const downloadStream = yield this.getFileStream(resource);
            return this.downloadToBuffer(downloadStream);
        });
    }
    downloadToFile(resource, downloadPath) {
        return __awaiter(this, void 0, void 0, function* () {
            const downloadStream = yield this.getFileStream(resource);
            yield stream_1.default.promises.pipeline(downloadStream, fs_1.default.createWriteStream(downloadPath));
        });
    }
    getFileStream(resource) {
        const storageProvider = (0, getStorageProvider_1.default)(resource);
        let storageProviderToInvoke;
        if (this.chunkSize && this.concurrency) {
            const chunkedDownloadWithRetry = (0, ChunksDownloadDecorator_1.createDownloadChunkMethodWithRetry)(ChunksDownloadDecorator_1.downloadChunkMethod, this.retry);
            storageProviderToInvoke = new ChunksDownloadDecorator_1.DownloadDecorator(storageProvider, chunkedDownloadWithRetry, {
                chunkSize: this.chunkSize,
                concurrency: this.concurrency,
                offset: this.startOffset,
            });
        }
        else {
            storageProviderToInvoke = storageProvider;
        }
        return storageProviderToInvoke.downloadFile(resource.filepath, {}, this.progressListener);
    }
}
exports.StorageProviderLoader = StorageProviderLoader;
StorageProviderLoader.DEFAULT_RETRY_COUNT = 3;
StorageProviderLoader.DEFAULT_START_OFFSET = 0;
StorageProviderLoader.type = dto_js_1.ResourceType.StorageProvider;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU3RvcmFnZVByb3ZpZGVyTG9hZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3V0aWxzL3Jlc291cmNlTG9hZGVycy9TdG9yYWdlUHJvdmlkZXJMb2FkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsNENBQW9CO0FBQ3BCLG9EQUE0QjtBQUM1QixtREFBeUY7QUFDekYsNkZBS3lEO0FBRXpELG9HQUE0RTtBQUU1RSw2REFBMEQ7QUFFMUQsTUFBYSxxQkFBc0IsU0FBUSx1Q0FBa0I7SUFXM0QsWUFBWSxTQUErQixFQUFFOztRQUMzQyxLQUFLLEVBQUUsQ0FBQztRQUNSLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxNQUFNLENBQUMsZ0JBQWdCLENBQUM7UUFDaEQsSUFBSSxDQUFDLFNBQVMsR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDO1FBQ2xDLElBQUksQ0FBQyxXQUFXLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQztRQUN0QyxJQUFJLENBQUMsV0FBVyxHQUFHLE1BQU0sQ0FBQyxXQUFXLElBQUkscUJBQXFCLENBQUMsb0JBQW9CLENBQUM7UUFDcEYsSUFBSSxDQUFDLEtBQUssR0FBRztZQUNYLGFBQWEsRUFBRSxDQUFBLE1BQUEsTUFBTSxDQUFDLEtBQUssMENBQUUsYUFBYSxLQUFJLHFCQUFxQixDQUFDLG1CQUFtQjtZQUN2RixPQUFPLEVBQUUsTUFBQSxNQUFNLENBQUMsS0FBSywwQ0FBRSxPQUFPO1lBQzlCLG9CQUFvQixFQUFFLE1BQUEsTUFBTSxDQUFDLEtBQUssMENBQUUsb0JBQW9CO1NBQ3pELENBQUM7SUFDSixDQUFDO0lBRVksUUFBUSxDQUFDLFFBQWtCOztZQUN0QyxNQUFNLGNBQWMsR0FBRyxNQUFNLElBQUksQ0FBQyxhQUFhLENBQUMsUUFBbUMsQ0FBQyxDQUFDO1lBRXJGLE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQy9DLENBQUM7S0FBQTtJQUVZLGNBQWMsQ0FBQyxRQUFrQixFQUFFLFlBQW9COztZQUNsRSxNQUFNLGNBQWMsR0FBRyxNQUFNLElBQUksQ0FBQyxhQUFhLENBQUMsUUFBbUMsQ0FBQyxDQUFDO1lBRXJGLE1BQU0sZ0JBQU0sQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLGNBQWMsRUFBRSxZQUFFLENBQUMsaUJBQWlCLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztRQUNyRixDQUFDO0tBQUE7SUFFTyxhQUFhLENBQUMsUUFBaUM7UUFDckQsTUFBTSxlQUFlLEdBQUcsSUFBQSw0QkFBa0IsRUFBQyxRQUFRLENBQUMsQ0FBQztRQUVyRCxJQUFJLHVCQUF5QyxDQUFDO1FBRTlDLElBQUksSUFBSSxDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUMsV0FBVyxFQUFFO1lBQ3RDLE1BQU0sd0JBQXdCLEdBQUcsSUFBQSw0REFBa0MsRUFDakUsNkNBQW1CLEVBQ25CLElBQUksQ0FBQyxLQUFLLENBQ1gsQ0FBQztZQUVGLHVCQUF1QixHQUFHLElBQUksMkNBQWlCLENBQUMsZUFBZSxFQUFFLHdCQUF3QixFQUFFO2dCQUN6RixTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7Z0JBQ3pCLFdBQVcsRUFBRSxJQUFJLENBQUMsV0FBVztnQkFDN0IsTUFBTSxFQUFFLElBQUksQ0FBQyxXQUFXO2FBQ3pCLENBQUMsQ0FBQztTQUNKO2FBQU07WUFDTCx1QkFBdUIsR0FBRyxlQUFlLENBQUM7U0FDM0M7UUFFRCxPQUFPLHVCQUF1QixDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsUUFBUSxFQUFFLEVBQUUsRUFBRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztJQUM1RixDQUFDOztBQXpESCxzREEwREM7QUF6RGdCLHlDQUFtQixHQUFHLENBQUMsQ0FBQztBQUN4QiwwQ0FBb0IsR0FBRyxDQUFDLENBQUM7QUFFMUIsMEJBQUksR0FBRyxxQkFBWSxDQUFDLGVBQWUsQ0FBQyJ9