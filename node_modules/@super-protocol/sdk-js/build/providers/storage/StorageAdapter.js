"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.CacheEvents = void 0;
const lru_cache_1 = require("lru-cache");
const crypto_1 = require("crypto");
const p_queue_1 = __importDefault(require("p-queue"));
const StorageKeyValueAdapter_1 = __importDefault(require("./StorageKeyValueAdapter"));
const StorageContentWriter_1 = __importStar(require("./StorageContentWriter"));
const StorageMetadataReader_1 = __importDefault(require("./StorageMetadataReader"));
const logger_1 = __importDefault(require("../../logger"));
const PubSub_1 = __importDefault(require("../../utils/PubSub"));
var CacheEvents;
(function (CacheEvents) {
    CacheEvents["INSTANCES_CHANGED"] = "INSTANCES_CHANGED";
    CacheEvents["KEY_DELETED"] = "KEY_DELETED";
})(CacheEvents = exports.CacheEvents || (exports.CacheEvents = {}));
const DEFAULT_READ_METADATA_CONCUREENCY = 16;
class StorageAdapter {
    constructor(storageAccess, config) {
        this.encryptionKeys = new Map(); // key -> encryption key (base64)
        this.timeout = null;
        this.queues = new Map();
        this.isUpdating = new Map();
        this.pubSub = new PubSub_1.default();
        this.eventName = 'storage-adapter';
        const { readInterval, writeInterval, lruCache, objectDeletedFlag, readMetadataConcurrency, performance, showLogs = true, } = config;
        this.logger = showLogs ? logger_1.default.child({ class: StorageAdapter.name }) : null;
        this.performance = performance;
        this.instanceId = this.generateHash();
        this.readInterval = readInterval;
        this.storageKeyValueAdapter = new StorageKeyValueAdapter_1.default(storageAccess, { showLogs });
        this.cache = new lru_cache_1.LRUCache(lruCache);
        this.metadataReader = new StorageMetadataReader_1.default({
            storageKeyValueAdapter: this.storageKeyValueAdapter,
            objectDeletedFlag,
            showLogs,
        });
        this.contentWriter = new StorageContentWriter_1.default({
            interval: writeInterval,
            storageKeyValueAdapter: this.storageKeyValueAdapter,
            instanceId: this.instanceId,
            objectDeletedFlag,
            performance: this.performance,
            showLogs,
        });
        this.queueReadMetadata = new p_queue_1.default({
            concurrency: readMetadataConcurrency || DEFAULT_READ_METADATA_CONCUREENCY,
        });
    }
    generateHash(str) {
        return (0, crypto_1.createHash)('sha256')
            .update(str || (0, crypto_1.randomUUID)())
            .digest('hex');
    }
    subscribe(cb) {
        return __awaiter(this, void 0, void 0, function* () {
            this.pubSub.subscribe(this.eventName, cb);
            return () => __awaiter(this, void 0, void 0, function* () {
                this.pubSub.unsubscribe(this.eventName, cb);
            });
        });
    }
    publish(type, message) {
        this.pubSub.publish(this.eventName, {
            type,
            message,
        });
    }
    has(key) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!this.cache.has(key)) {
                yield this.getQueue(key).add(() => __awaiter(this, void 0, void 0, function* () {
                    if (!this.cache.has(key)) {
                        yield this.checkUpdates(key);
                    }
                }));
            }
            return this.cache.has(key);
        });
    }
    getEnryptionKey(key, encryptionKeyBuffer) {
        if (!this.encryptionKeys.has(key)) {
            if (!encryptionKeyBuffer)
                return null;
            const encryptionKey = encryptionKeyBuffer.toString('base64');
            this.encryptionKeys.set(key, encryptionKey);
            return encryptionKey;
        }
        return this.encryptionKeys.get(key) || null;
    }
    set(key, value, encryptionKeyBuffer) {
        var _a;
        return __awaiter(this, void 0, void 0, function* () {
            if (((_a = this.contentWriter.storageWrites.get(key)) === null || _a === void 0 ? void 0 : _a.type) === StorageContentWriter_1.ContentWriterType.NEEDS_DELETE) {
                throw new Error('Object has been deleted');
            }
            const encryptionKey = this.getEnryptionKey(key, encryptionKeyBuffer);
            if (!encryptionKey)
                throw new Error('Encryption key required');
            this.setByInstance(key, this.instanceId, {
                value,
                modifiedTs: Number.MAX_SAFE_INTEGER,
            });
            this.contentWriter.set(key, StorageContentWriter_1.ContentWriterType.NEEDS_UPLOAD, encryptionKey);
        });
    }
    setByInstance(key, instanceId, value) {
        const instances = this.cache.get(key) || new Map();
        instances.set(instanceId, value);
        this.cache.set(key, instances);
    }
    delete(key) {
        var _a;
        return __awaiter(this, void 0, void 0, function* () {
            this.cache.delete(key);
            this.isUpdating.delete(key);
            const encryptionKey = this.getEnryptionKey(key);
            if (encryptionKey) {
                this.contentWriter.set(key, StorageContentWriter_1.ContentWriterType.NEEDS_DELETE, encryptionKey);
                this.encryptionKeys.delete(key);
            }
            else {
                (_a = this.logger) === null || _a === void 0 ? void 0 : _a.error(`Encryption key for key ${key} is not set`);
            }
            this.clearQueue(key);
        });
    }
    // the first value is always the current instance, if key exists
    get(key, encryptionKeyBuffer) {
        var _a, _b;
        return __awaiter(this, void 0, void 0, function* () {
            if (!encryptionKeyBuffer)
                throw new Error('Encryption key required');
            if (((_a = this.contentWriter.storageWrites.get(key)) === null || _a === void 0 ? void 0 : _a.type) === StorageContentWriter_1.ContentWriterType.NEEDS_DELETE ||
                !(yield this.has(key))) {
                return null;
            }
            const encryptionKey = this.getEnryptionKey(key, encryptionKeyBuffer);
            if (!encryptionKey)
                throw new Error('Encryption key required');
            if (this.cacheHasNullInstances(key)) {
                yield this.getQueue(key).add(() => __awaiter(this, void 0, void 0, function* () {
                    if (this.cacheHasNullInstances(key)) {
                        yield this.fetchNullValues(key, encryptionKey);
                    }
                }));
            }
            const map = this.cache.get(key);
            if (!(map === null || map === void 0 ? void 0 : map.size))
                return null;
            const currentInstance = ((_b = map.get(this.instanceId)) === null || _b === void 0 ? void 0 : _b.value) || null;
            const otherInstances = Array.from(map.entries()).reduce((acc, [instanceId, instance]) => {
                return instanceId !== this.instanceId ? [...acc, (instance === null || instance === void 0 ? void 0 : instance.value) || null] : acc;
            }, []);
            return [currentInstance, ...otherInstances];
        });
    }
    getQueue(key) {
        let queue = this.queues.get(key);
        if (!queue) {
            queue = new p_queue_1.default({ concurrency: 1 });
            this.queues.set(key, queue);
        }
        return queue;
    }
    clearQueue(key) {
        const queue = this.queues.get(key);
        queue === null || queue === void 0 ? void 0 : queue.clear();
        this.queues.delete(key);
    }
    cacheHasNullInstances(key) {
        var _a;
        return Array.from(((_a = this.cache.get(key)) === null || _a === void 0 ? void 0 : _a.values()) || []).some((instance) => instance.value === null);
    }
    fetchNullValues(key, encryptionKey) {
        var _a;
        return __awaiter(this, void 0, void 0, function* () {
            const promises = [];
            (_a = this.cache.get(key)) === null || _a === void 0 ? void 0 : _a.forEach((instance, instanseId) => {
                var _a;
                if (instance.value === null) {
                    const fileName = `${key}/${instanseId}`;
                    const startDownload = (_a = this.performance) === null || _a === void 0 ? void 0 : _a.now();
                    promises.push(this.storageKeyValueAdapter
                        .get(fileName, encryptionKey)
                        .then((file) => {
                        if (this.performance && startDownload !== undefined) {
                            const finishDownload = this.performance.now();
                            logger_1.default.info(`Downloading took ${(finishDownload - startDownload).toFixed(1)} ms`);
                        }
                        this.setByInstance(key, instanseId, Object.assign(Object.assign({}, instance), { value: file }));
                    })
                        .catch((err) => { var _a; return (_a = this.logger) === null || _a === void 0 ? void 0 : _a.error({ err }, 'Error fetching content'); }));
                }
            });
            yield Promise.all(promises);
        });
    }
    clear() {
        this.cache.clear();
        this.contentWriter.clear();
    }
    run() {
        this.contentWriter.startActualizeCacheTimer(this.cache);
        if (this.readInterval) {
            this.startUpdatesChecking();
        }
    }
    checkUpdates(key) {
        var _a, _b;
        return __awaiter(this, void 0, void 0, function* () {
            if (this.isUpdating.get(key) ||
                ((_a = this.contentWriter.storageWrites.get(key)) === null || _a === void 0 ? void 0 : _a.type) === StorageContentWriter_1.ContentWriterType.NEEDS_DELETE) {
                return;
            }
            this.isUpdating.set(key, true);
            try {
                if (!this.cache.has(key)) {
                    this.cache.set(key, new Map());
                }
                const cachedByKey = this.cache.get(key);
                const initialSize = cachedByKey.size;
                const { updated, deleted } = yield this.metadataReader.fetchInstancesUpdates(key, cachedByKey);
                if (deleted.has(key)) {
                    yield this.delete(key);
                    this.publish(CacheEvents.KEY_DELETED, key);
                    return;
                }
                updated.forEach((storageObject, instanceId) => {
                    cachedByKey.set(instanceId, {
                        value: null,
                        modifiedTs: storageObject.createdAt.getTime(),
                    });
                });
                if (updated.size && initialSize) {
                    this.publish(CacheEvents.INSTANCES_CHANGED, key);
                }
                deleted.forEach((instanceId) => {
                    if (instanceId !== this.instanceId) {
                        cachedByKey.delete(instanceId);
                    }
                });
                if (!cachedByKey.size) {
                    this.cache.delete(key);
                }
            }
            catch (err) {
                (_b = this.logger) === null || _b === void 0 ? void 0 : _b.error({ err }, 'Error checking updates');
                return;
            }
            finally {
                this.isUpdating.set(key, false);
            }
        });
    }
    startUpdatesChecking() {
        return __awaiter(this, void 0, void 0, function* () {
            this.stopUpdatesChecking();
            this.timeout = setTimeout(() => __awaiter(this, void 0, void 0, function* () {
                Array.from(this.cache.keys()).forEach((key) => {
                    this.queueReadMetadata.add(() => __awaiter(this, void 0, void 0, function* () {
                        yield this.getQueue(key).add(() => __awaiter(this, void 0, void 0, function* () {
                            yield this.checkUpdates(key);
                        }));
                    }));
                });
                yield this.queueReadMetadata.onIdle();
                this.startUpdatesChecking();
            }), this.readInterval);
        });
    }
    stopUpdatesChecking() {
        if (this.timeout)
            clearTimeout(this.timeout);
    }
    stop() {
        this.stopUpdatesChecking();
        this.contentWriter.stop();
    }
    shutdown() {
        return __awaiter(this, void 0, void 0, function* () {
            this.stop();
            yield this.contentWriter.shutdown(this.cache);
        });
    }
}
exports.default = StorageAdapter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU3RvcmFnZUFkYXB0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvcHJvdmlkZXJzL3N0b3JhZ2UvU3RvcmFnZUFkYXB0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSx5Q0FBcUM7QUFDckMsbUNBQWdEO0FBQ2hELHNEQUE0QjtBQUM1QixzRkFBOEQ7QUFDOUQsK0VBQWlGO0FBQ2pGLG9GQUE0RDtBQUU1RCwwREFBOEM7QUFFOUMsZ0VBQXdDO0FBZ0J4QyxJQUFZLFdBR1g7QUFIRCxXQUFZLFdBQVc7SUFDckIsc0RBQXVDLENBQUE7SUFDdkMsMENBQTJCLENBQUE7QUFDN0IsQ0FBQyxFQUhXLFdBQVcsR0FBWCxtQkFBVyxLQUFYLG1CQUFXLFFBR3RCO0FBRUQsTUFBTSxpQ0FBaUMsR0FBRyxFQUFFLENBQUM7QUFFN0MsTUFBcUIsY0FBYztJQWlCakMsWUFBWSxhQUE0QixFQUFFLE1BQTRCO1FBYnJELG1CQUFjLEdBQUcsSUFBSSxHQUFHLEVBQWtCLENBQUMsQ0FBQyxpQ0FBaUM7UUFJdEYsWUFBTyxHQUF5QyxJQUFJLENBQUM7UUFFNUMsV0FBTSxHQUFHLElBQUksR0FBRyxFQUFpQixDQUFDO1FBRWxDLGVBQVUsR0FBRyxJQUFJLEdBQUcsRUFBbUIsQ0FBQztRQUN4QyxXQUFNLEdBQTRELElBQUksZ0JBQU0sRUFBRSxDQUFDO1FBQy9FLGNBQVMsR0FBRyxpQkFBaUIsQ0FBQztRQUk3QyxNQUFNLEVBQ0osWUFBWSxFQUNaLGFBQWEsRUFDYixRQUFRLEVBQ1IsaUJBQWlCLEVBQ2pCLHVCQUF1QixFQUN2QixXQUFXLEVBQ1gsUUFBUSxHQUFHLElBQUksR0FDaEIsR0FBRyxNQUFNLENBQUM7UUFDWCxJQUFJLENBQUMsTUFBTSxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsZ0JBQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxLQUFLLEVBQUUsY0FBYyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztRQUM3RSxJQUFJLENBQUMsV0FBVyxHQUFHLFdBQVcsQ0FBQztRQUMvQixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUN0QyxJQUFJLENBQUMsWUFBWSxHQUFHLFlBQVksQ0FBQztRQUNqQyxJQUFJLENBQUMsc0JBQXNCLEdBQUcsSUFBSSxnQ0FBc0IsQ0FBQyxhQUFhLEVBQUUsRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFDO1FBQ3RGLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxvQkFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3BDLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSwrQkFBcUIsQ0FBQztZQUM5QyxzQkFBc0IsRUFBRSxJQUFJLENBQUMsc0JBQXNCO1lBQ25ELGlCQUFpQjtZQUNqQixRQUFRO1NBQ1QsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLDhCQUFvQixDQUFDO1lBQzVDLFFBQVEsRUFBRSxhQUFhO1lBQ3ZCLHNCQUFzQixFQUFFLElBQUksQ0FBQyxzQkFBc0I7WUFDbkQsVUFBVSxFQUFFLElBQUksQ0FBQyxVQUFVO1lBQzNCLGlCQUFpQjtZQUNqQixXQUFXLEVBQUUsSUFBSSxDQUFDLFdBQVc7WUFDN0IsUUFBUTtTQUNULENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLGlCQUFLLENBQUM7WUFDakMsV0FBVyxFQUFFLHVCQUF1QixJQUFJLGlDQUFpQztTQUMxRSxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU8sWUFBWSxDQUFDLEdBQVk7UUFDL0IsT0FBTyxJQUFBLG1CQUFVLEVBQUMsUUFBUSxDQUFDO2FBQ3hCLE1BQU0sQ0FBQyxHQUFHLElBQUksSUFBQSxtQkFBVSxHQUFFLENBQUM7YUFDM0IsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ25CLENBQUM7SUFFWSxTQUFTLENBQ3BCLEVBQTREOztZQUU1RCxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBRTFDLE9BQU8sR0FBUyxFQUFFO2dCQUNoQixJQUFJLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQzlDLENBQUMsQ0FBQSxDQUFDO1FBQ0osQ0FBQztLQUFBO0lBRU8sT0FBTyxDQUFDLElBQWlCLEVBQUUsT0FBZ0I7UUFDakQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNsQyxJQUFJO1lBQ0osT0FBTztTQUNSLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFWSxHQUFHLENBQUMsR0FBVzs7WUFDMUIsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFO2dCQUN4QixNQUFNLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQVMsRUFBRTtvQkFDdEMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFO3dCQUN4QixNQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLENBQUM7cUJBQzlCO2dCQUNILENBQUMsQ0FBQSxDQUFDLENBQUM7YUFDSjtZQUVELE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDN0IsQ0FBQztLQUFBO0lBRU8sZUFBZSxDQUFDLEdBQVcsRUFBRSxtQkFBNEI7UUFDL0QsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ2pDLElBQUksQ0FBQyxtQkFBbUI7Z0JBQUUsT0FBTyxJQUFJLENBQUM7WUFDdEMsTUFBTSxhQUFhLEdBQUcsbUJBQW1CLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQzdELElBQUksQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxhQUFhLENBQUMsQ0FBQztZQUU1QyxPQUFPLGFBQWEsQ0FBQztTQUN0QjtRQUVELE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksSUFBSSxDQUFDO0lBQzlDLENBQUM7SUFFWSxHQUFHLENBQUMsR0FBVyxFQUFFLEtBQVEsRUFBRSxtQkFBMkI7OztZQUNqRSxJQUFJLENBQUEsTUFBQSxJQUFJLENBQUMsYUFBYSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLDBDQUFFLElBQUksTUFBSyx3Q0FBaUIsQ0FBQyxZQUFZLEVBQUU7Z0JBQ3RGLE1BQU0sSUFBSSxLQUFLLENBQUMseUJBQXlCLENBQUMsQ0FBQzthQUM1QztZQUNELE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsR0FBRyxFQUFFLG1CQUFtQixDQUFDLENBQUM7WUFDckUsSUFBSSxDQUFDLGFBQWE7Z0JBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO1lBQy9ELElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxVQUFVLEVBQUU7Z0JBQ3ZDLEtBQUs7Z0JBQ0wsVUFBVSxFQUFFLE1BQU0sQ0FBQyxnQkFBZ0I7YUFDcEMsQ0FBQyxDQUFDO1lBQ0gsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLHdDQUFpQixDQUFDLFlBQVksRUFBRSxhQUFhLENBQUMsQ0FBQzs7S0FDNUU7SUFFTyxhQUFhLENBQUMsR0FBVyxFQUFFLFVBQWtCLEVBQUUsS0FBcUI7UUFDMUUsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUNuRCxTQUFTLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNqQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsU0FBUyxDQUFDLENBQUM7SUFDakMsQ0FBQztJQUVZLE1BQU0sQ0FBQyxHQUFXOzs7WUFDN0IsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDdkIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7WUFFNUIsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNoRCxJQUFJLGFBQWEsRUFBRTtnQkFDakIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLHdDQUFpQixDQUFDLFlBQVksRUFBRSxhQUFhLENBQUMsQ0FBQztnQkFDM0UsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7YUFDakM7aUJBQU07Z0JBQ0wsTUFBQSxJQUFJLENBQUMsTUFBTSwwQ0FBRSxLQUFLLENBQUMsMEJBQTBCLEdBQUcsYUFBYSxDQUFDLENBQUM7YUFDaEU7WUFFRCxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDOztLQUN0QjtJQUVELGdFQUFnRTtJQUNuRCxHQUFHLENBQUMsR0FBVyxFQUFFLG1CQUEyQjs7O1lBQ3ZELElBQUksQ0FBQyxtQkFBbUI7Z0JBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO1lBQ3JFLElBQ0UsQ0FBQSxNQUFBLElBQUksQ0FBQyxhQUFhLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsMENBQUUsSUFBSSxNQUFLLHdDQUFpQixDQUFDLFlBQVk7Z0JBQ2xGLENBQUMsQ0FBQyxNQUFNLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsRUFDdEI7Z0JBQ0EsT0FBTyxJQUFJLENBQUM7YUFDYjtZQUNELE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsR0FBRyxFQUFFLG1CQUFtQixDQUFDLENBQUM7WUFDckUsSUFBSSxDQUFDLGFBQWE7Z0JBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO1lBQy9ELElBQUksSUFBSSxDQUFDLHFCQUFxQixDQUFDLEdBQUcsQ0FBQyxFQUFFO2dCQUNuQyxNQUFNLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQVMsRUFBRTtvQkFDdEMsSUFBSSxJQUFJLENBQUMscUJBQXFCLENBQUMsR0FBRyxDQUFDLEVBQUU7d0JBQ25DLE1BQU0sSUFBSSxDQUFDLGVBQWUsQ0FBQyxHQUFHLEVBQUUsYUFBYSxDQUFDLENBQUM7cUJBQ2hEO2dCQUNILENBQUMsQ0FBQSxDQUFDLENBQUM7YUFDSjtZQUVELE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ2hDLElBQUksQ0FBQyxDQUFBLEdBQUcsYUFBSCxHQUFHLHVCQUFILEdBQUcsQ0FBRSxJQUFJLENBQUE7Z0JBQUUsT0FBTyxJQUFJLENBQUM7WUFDNUIsTUFBTSxlQUFlLEdBQUcsQ0FBQSxNQUFBLEdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQywwQ0FBRSxLQUFLLEtBQUksSUFBSSxDQUFDO1lBQ2hFLE1BQU0sY0FBYyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsVUFBVSxFQUFFLFFBQVEsQ0FBQyxFQUFFLEVBQUU7Z0JBQ3RGLE9BQU8sVUFBVSxLQUFLLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLEVBQUUsQ0FBQSxRQUFRLGFBQVIsUUFBUSx1QkFBUixRQUFRLENBQUUsS0FBSyxLQUFJLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUM7WUFDbEYsQ0FBQyxFQUFFLEVBQWtCLENBQUMsQ0FBQztZQUV2QixPQUFPLENBQUMsZUFBZSxFQUFFLEdBQUcsY0FBYyxDQUFDLENBQUM7O0tBQzdDO0lBRU8sUUFBUSxDQUFDLEdBQVc7UUFDMUIsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFakMsSUFBSSxDQUFDLEtBQUssRUFBRTtZQUNWLEtBQUssR0FBRyxJQUFJLGlCQUFLLENBQUMsRUFBRSxXQUFXLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUN0QyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDN0I7UUFFRCxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7SUFFTyxVQUFVLENBQUMsR0FBVztRQUM1QixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNuQyxLQUFLLGFBQUwsS0FBSyx1QkFBTCxLQUFLLENBQUUsS0FBSyxFQUFFLENBQUM7UUFDZixJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUMxQixDQUFDO0lBRU8scUJBQXFCLENBQUMsR0FBVzs7UUFDdkMsT0FBTyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUEsTUFBQSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsMENBQUUsTUFBTSxFQUFFLEtBQUksRUFBRSxDQUFDLENBQUMsSUFBSSxDQUN6RCxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsUUFBUSxDQUFDLEtBQUssS0FBSyxJQUFJLENBQ3RDLENBQUM7SUFDSixDQUFDO0lBRWEsZUFBZSxDQUFDLEdBQVcsRUFBRSxhQUFxQjs7O1lBQzlELE1BQU0sUUFBUSxHQUFvQixFQUFFLENBQUM7WUFFckMsTUFBQSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsMENBQUUsT0FBTyxDQUFDLENBQUMsUUFBUSxFQUFFLFVBQVUsRUFBRSxFQUFFOztnQkFDcEQsSUFBSSxRQUFRLENBQUMsS0FBSyxLQUFLLElBQUksRUFBRTtvQkFDM0IsTUFBTSxRQUFRLEdBQUcsR0FBRyxHQUFHLElBQUksVUFBVSxFQUFFLENBQUM7b0JBQ3hDLE1BQU0sYUFBYSxHQUF1QixNQUFBLElBQUksQ0FBQyxXQUFXLDBDQUFFLEdBQUcsRUFBRSxDQUFDO29CQUVsRSxRQUFRLENBQUMsSUFBSSxDQUNYLElBQUksQ0FBQyxzQkFBc0I7eUJBQ3hCLEdBQUcsQ0FBQyxRQUFRLEVBQUUsYUFBYSxDQUFDO3lCQUM1QixJQUFJLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRTt3QkFDYixJQUFJLElBQUksQ0FBQyxXQUFXLElBQUksYUFBYSxLQUFLLFNBQVMsRUFBRTs0QkFDbkQsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLEVBQUUsQ0FBQzs0QkFDOUMsZ0JBQU0sQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsY0FBYyxHQUFHLGFBQWEsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUM7eUJBQ25GO3dCQUNELElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxFQUFFLFVBQVUsa0NBQzdCLFFBQVEsS0FDWCxLQUFLLEVBQUUsSUFBSSxJQUNYLENBQUM7b0JBQ0wsQ0FBQyxDQUFDO3lCQUNELEtBQUssQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLFdBQUMsT0FBQSxNQUFBLElBQUksQ0FBQyxNQUFNLDBDQUFFLEtBQUssQ0FBQyxFQUFFLEdBQUcsRUFBRSxFQUFFLHdCQUF3QixDQUFDLENBQUEsRUFBQSxDQUFDLENBQ3pFLENBQUM7aUJBQ0g7WUFDSCxDQUFDLENBQUMsQ0FBQztZQUVILE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQzs7S0FDN0I7SUFFTSxLQUFLO1FBQ1YsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNuQixJQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQzdCLENBQUM7SUFFTSxHQUFHO1FBQ1IsSUFBSSxDQUFDLGFBQWEsQ0FBQyx3QkFBd0IsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFeEQsSUFBSSxJQUFJLENBQUMsWUFBWSxFQUFFO1lBQ3JCLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1NBQzdCO0lBQ0gsQ0FBQztJQUVhLFlBQVksQ0FBQyxHQUFXOzs7WUFDcEMsSUFDRSxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUM7Z0JBQ3hCLENBQUEsTUFBQSxJQUFJLENBQUMsYUFBYSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLDBDQUFFLElBQUksTUFBSyx3Q0FBaUIsQ0FBQyxZQUFZLEVBQ2xGO2dCQUNBLE9BQU87YUFDUjtZQUNELElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQztZQUUvQixJQUFJO2dCQUNGLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRTtvQkFDeEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLElBQUksR0FBRyxFQUFFLENBQUMsQ0FBQztpQkFDaEM7Z0JBQ0QsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFnQyxDQUFDO2dCQUN2RSxNQUFNLFdBQVcsR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDO2dCQUVyQyxNQUFNLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxHQUFHLE1BQU0sSUFBSSxDQUFDLGNBQWMsQ0FBQyxxQkFBcUIsQ0FDMUUsR0FBRyxFQUNILFdBQVcsQ0FDWixDQUFDO2dCQUVGLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRTtvQkFDcEIsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO29CQUN2QixJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxXQUFXLEVBQUUsR0FBRyxDQUFDLENBQUM7b0JBRTNDLE9BQU87aUJBQ1I7Z0JBRUQsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLGFBQWEsRUFBRSxVQUFVLEVBQUUsRUFBRTtvQkFDNUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUU7d0JBQzFCLEtBQUssRUFBRSxJQUFJO3dCQUNYLFVBQVUsRUFBRSxhQUFhLENBQUMsU0FBUyxDQUFDLE9BQU8sRUFBRTtxQkFDOUMsQ0FBQyxDQUFDO2dCQUNMLENBQUMsQ0FBQyxDQUFDO2dCQUVILElBQUksT0FBTyxDQUFDLElBQUksSUFBSSxXQUFXLEVBQUU7b0JBQy9CLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLGlCQUFpQixFQUFFLEdBQUcsQ0FBQyxDQUFDO2lCQUNsRDtnQkFFRCxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsVUFBVSxFQUFFLEVBQUU7b0JBQzdCLElBQUksVUFBVSxLQUFLLElBQUksQ0FBQyxVQUFVLEVBQUU7d0JBQ2xDLFdBQVcsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUM7cUJBQ2hDO2dCQUNILENBQUMsQ0FBQyxDQUFDO2dCQUVILElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFO29CQUNyQixJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztpQkFDeEI7YUFDRjtZQUFDLE9BQU8sR0FBRyxFQUFFO2dCQUNaLE1BQUEsSUFBSSxDQUFDLE1BQU0sMENBQUUsS0FBSyxDQUFDLEVBQUUsR0FBRyxFQUFFLEVBQUUsd0JBQXdCLENBQUMsQ0FBQztnQkFFdEQsT0FBTzthQUNSO29CQUFTO2dCQUNSLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQzthQUNqQzs7S0FDRjtJQUVhLG9CQUFvQjs7WUFDaEMsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7WUFDM0IsSUFBSSxDQUFDLE9BQU8sR0FBRyxVQUFVLENBQUMsR0FBUyxFQUFFO2dCQUNuQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRTtvQkFDNUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLEdBQUcsQ0FBQyxHQUFTLEVBQUU7d0JBQ3BDLE1BQU0sSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBUyxFQUFFOzRCQUN0QyxNQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLENBQUM7d0JBQy9CLENBQUMsQ0FBQSxDQUFDLENBQUM7b0JBQ0wsQ0FBQyxDQUFBLENBQUMsQ0FBQztnQkFDTCxDQUFDLENBQUMsQ0FBQztnQkFFSCxNQUFNLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLEVBQUUsQ0FBQztnQkFFdEMsSUFBSSxDQUFDLG9CQUFvQixFQUFFLENBQUM7WUFDOUIsQ0FBQyxDQUFBLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ3hCLENBQUM7S0FBQTtJQUVPLG1CQUFtQjtRQUN6QixJQUFJLElBQUksQ0FBQyxPQUFPO1lBQUUsWUFBWSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUMvQyxDQUFDO0lBRU0sSUFBSTtRQUNULElBQUksQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO1FBQzNCLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDNUIsQ0FBQztJQUVZLFFBQVE7O1lBQ25CLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNaLE1BQU0sSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2hELENBQUM7S0FBQTtDQUNGO0FBMVRELGlDQTBUQyJ9