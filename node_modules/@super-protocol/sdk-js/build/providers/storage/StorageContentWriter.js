"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ContentWriterType = void 0;
const p_queue_1 = __importDefault(require("p-queue"));
const logger_1 = __importDefault(require("../../logger"));
var ContentWriterType;
(function (ContentWriterType) {
    ContentWriterType["NEEDS_UPLOAD"] = "NEEDS_UPLOAD";
    ContentWriterType["NEEDS_DELETE"] = "NEEDS_DELETE";
})(ContentWriterType = exports.ContentWriterType || (exports.ContentWriterType = {}));
const DEFAULT_WRITE_CONTENT_CONCURRENCY = 16;
const DEFAULT_CACHE_EXPIRATION_TS = 5 * 60 * 1000;
class StorageContentWriter {
    constructor(config) {
        this.timeout = null;
        this.storageWrites = new Map();
        const { writeContentConcurrency, interval, storageKeyValueAdapter, instanceId, objectDeletedFlag, cacheExpirationTs, performance, showLogs = true, } = config || {};
        this.logger = showLogs ? logger_1.default.child({ class: StorageContentWriter.name }) : null;
        this.performance = performance;
        this.INTERVAL = interval;
        this.cacheExpirationTs = cacheExpirationTs || DEFAULT_CACHE_EXPIRATION_TS;
        this.storageKeyValueAdapter = storageKeyValueAdapter;
        this.instanceId = instanceId;
        this.objectDeletedFlag = objectDeletedFlag;
        this.queueWriteContent = new p_queue_1.default({
            concurrency: writeContentConcurrency || DEFAULT_WRITE_CONTENT_CONCURRENCY,
        });
    }
    actualizeCacheDelete(key, encryptionKey) {
        return __awaiter(this, void 0, void 0, function* () {
            const objects = yield this.storageKeyValueAdapter.listFiles(key);
            const objectsToDelete = objects.filter((object) => !object.name.endsWith(this.objectDeletedFlag));
            yield Promise.all(objectsToDelete.map((object) => this.storageKeyValueAdapter.delete(object.name)));
            if (objectsToDelete.length === objects.length) {
                yield this.storageKeyValueAdapter.set(`${key}/${this.objectDeletedFlag}`, null, encryptionKey);
            }
        });
    }
    actualizeCacheUpload(key, encryptionKey, cache) {
        var _a, _b, _c;
        return __awaiter(this, void 0, void 0, function* () {
            const instances = cache.get(key);
            const instance = instances === null || instances === void 0 ? void 0 : instances.get(this.instanceId);
            if (!instances || !instance) {
                (_a = this.logger) === null || _a === void 0 ? void 0 : _a.error({
                    key,
                    instancesSize: instances === null || instances === void 0 ? void 0 : instances.size,
                    value: instance,
                }, 'Attempted to upload non-existing value');
                return;
            }
            if (instance.value) {
                const startUpload = (_b = this.performance) === null || _b === void 0 ? void 0 : _b.now();
                yield this.storageKeyValueAdapter.set(`${key}/${this.instanceId}`, instance.value, encryptionKey);
                if (this.performance && startUpload !== undefined) {
                    const finishUpload = this.performance.now();
                    (_c = this.logger) === null || _c === void 0 ? void 0 : _c.info(`Uploading took ${(finishUpload - startUpload).toFixed(1)} ms`);
                }
            }
            yield this.deleteOutdatedInstances(key, instances);
        });
    }
    actualizeCache(cache) {
        var _a;
        return __awaiter(this, void 0, void 0, function* () {
            const logger = (_a = this.logger) === null || _a === void 0 ? void 0 : _a.child({ method: this.actualizeCache.name });
            if (this.storageWrites.size) {
                Array.from(this.storageWrites.entries()).forEach(([key, { type, index, encryptionKey }]) => {
                    this.queueWriteContent.add(() => __awaiter(this, void 0, void 0, function* () {
                        var _a;
                        try {
                            switch (type) {
                                case ContentWriterType.NEEDS_DELETE:
                                    yield this.actualizeCacheDelete(key, encryptionKey);
                                    break;
                                case ContentWriterType.NEEDS_UPLOAD:
                                    yield this.actualizeCacheUpload(key, encryptionKey, cache);
                                    break;
                                default:
                                    break;
                            }
                            // delete only if the current index is up to date
                            if (index === ((_a = this.storageWrites.get(key)) === null || _a === void 0 ? void 0 : _a.index)) {
                                this.storageWrites.delete(key);
                            }
                        }
                        catch (err) {
                            logger === null || logger === void 0 ? void 0 : logger.error({
                                err,
                                size: this.storageWrites.size,
                            }, `Error storage writing ${key}`);
                        }
                    }));
                });
                yield this.queueWriteContent.onIdle();
                logger === null || logger === void 0 ? void 0 : logger.info({ size: this.storageWrites.size }, 'Success storage writing');
            }
        });
    }
    deleteOutdatedInstances(key, instances) {
        return __awaiter(this, void 0, void 0, function* () {
            const expiredTs = Date.now() - this.cacheExpirationTs;
            const instancesToDelete = [];
            instances === null || instances === void 0 ? void 0 : instances.forEach((instance, instanceId) => {
                const isOutdated = instance.modifiedTs < expiredTs;
                const isNotNull = Boolean(instance.value);
                if (instanceId !== this.instanceId && isNotNull && isOutdated) {
                    instancesToDelete.push([instanceId, instance]);
                }
            });
            // For safety, always preserve one additional copy in storage
            if (instancesToDelete.length <= 1) {
                return;
            }
            // Finding the most up-to-date instance to preserve
            instancesToDelete
                .sort((a, b) => {
                const diff = a[1].modifiedTs - b[1].modifiedTs;
                if (diff === 0) {
                    return a[0] >= b[0] ? 1 : -1;
                }
                return diff;
            })
                .pop();
            yield Promise.allSettled(instancesToDelete.map(([instanceId]) => this.storageKeyValueAdapter
                .delete(`${key}/${instanceId}`)
                .then(() => {
                instances.delete(instanceId);
            })
                .catch((err) => { var _a; return (_a = this.logger) === null || _a === void 0 ? void 0 : _a.error({ err }, 'Error deleting outdated instance'); })));
        });
    }
    startActualizeCacheTimer(cache) {
        if (this.INTERVAL) {
            if (this.timeout)
                clearTimeout(this.timeout);
            this.timeout = setTimeout(() => __awaiter(this, void 0, void 0, function* () {
                yield this.actualizeCache(cache);
                this.startActualizeCacheTimer(cache);
            }), this.INTERVAL);
        }
    }
    stop() {
        if (this.timeout)
            clearTimeout(this.timeout);
        this.timeout = null;
    }
    set(key, type, encryptionKey) {
        const oldValue = this.storageWrites.get(key);
        this.storageWrites.set(key, {
            type,
            index: (oldValue === null || oldValue === void 0 ? void 0 : oldValue.index) ? oldValue.index + 1 : 1,
            encryptionKey,
        });
    }
    get(key) {
        var _a;
        return ((_a = this.storageWrites.get(key)) === null || _a === void 0 ? void 0 : _a.type) || null;
    }
    clear() {
        this.storageWrites.clear();
    }
    shutdown(cache) {
        return __awaiter(this, void 0, void 0, function* () {
            this.stop();
            yield this.actualizeCache(cache);
        });
    }
}
exports.default = StorageContentWriter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU3RvcmFnZUNvbnRlbnRXcml0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvcHJvdmlkZXJzL3N0b3JhZ2UvU3RvcmFnZUNvbnRlbnRXcml0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7O0FBQ0Esc0RBQTRCO0FBQzVCLDBEQUE4QztBQWU5QyxJQUFZLGlCQUdYO0FBSEQsV0FBWSxpQkFBaUI7SUFDM0Isa0RBQTZCLENBQUE7SUFDN0Isa0RBQTZCLENBQUE7QUFDL0IsQ0FBQyxFQUhXLGlCQUFpQixHQUFqQix5QkFBaUIsS0FBakIseUJBQWlCLFFBRzVCO0FBRUQsTUFBTSxpQ0FBaUMsR0FBRyxFQUFFLENBQUM7QUFDN0MsTUFBTSwyQkFBMkIsR0FBRyxDQUFDLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQztBQVFsRCxNQUFxQixvQkFBb0I7SUFZdkMsWUFBWSxNQUFxQztRQVh6QyxZQUFPLEdBQXlDLElBQUksQ0FBQztRQVM3QyxrQkFBYSxHQUErQixJQUFJLEdBQUcsRUFBRSxDQUFDO1FBR3BFLE1BQU0sRUFDSix1QkFBdUIsRUFDdkIsUUFBUSxFQUNSLHNCQUFzQixFQUN0QixVQUFVLEVBQ1YsaUJBQWlCLEVBQ2pCLGlCQUFpQixFQUNqQixXQUFXLEVBQ1gsUUFBUSxHQUFHLElBQUksR0FDaEIsR0FBRyxNQUFNLElBQUksRUFBRSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxNQUFNLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxnQkFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLEtBQUssRUFBRSxvQkFBb0IsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7UUFDbkYsSUFBSSxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUM7UUFDL0IsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7UUFDekIsSUFBSSxDQUFDLGlCQUFpQixHQUFHLGlCQUFpQixJQUFJLDJCQUEy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